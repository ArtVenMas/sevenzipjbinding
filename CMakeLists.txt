CMAKE_MINIMUM_REQUIRED(VERSION 2.6)
PROJECT(SevenZipJBinding)

INCLUDE(FindJava)

# Uncomment this to build a version
#SET(SEVENZIPJBINDING_VERSON 0.5.0)

IF (SEVENZIPJBINDING_VERSON)
    SET(RELEASE_PATH ${PROJECT_BINARY_DIR}/releases/${SEVENZIPJBINDING_VERSON})
    SET(SEVENZIPJBINDING_VERSON_POSTFIX "-${SEVENZIPJBINDING_VERSON}")
ELSE(SEVENZIPJBINDING_VERSON)
    SET(RELEASE_PATH ${PROJECT_BINARY_DIR})
    SET(SEVENZIPJBINDING_VERSON_POSTFIX "")
ENDIF(SEVENZIPJBINDING_VERSON)

SET(PLATFORM ${CMAKE_SYSTEM_NAME}-${CMAKE_SYSTEM_PROCESSOR})
SET(SEVENZIPJBINDING_LIB_JAR ${PROJECT_BINARY_DIR}/sevenzipjbinding-${PLATFORM}.jar)
SET(SEVENZIPJBINDING_ZIP ${RELEASE_PATH}/sevenzipjbinding${SEVENZIPJBINDING_VERSON_POSTFIX}.zip)


ADD_SUBDIRECTORY(jbinding-java)
ADD_SUBDIRECTORY(jbinding-cpp)

ADD_DEPENDENCIES(7-Zip-JBinding sevenzip-jbinding-jar)

GET_PROPERTY(SEVENZIP_JBINDING_JAR    GLOBAL PROPERTY     SEVENZIP_JBINDING_JAR) 
GET_PROPERTY(USE_MINGW                GLOBAL PROPERTY     USE_MINGW) 
GET_TARGET_PROPERTY(SEVENZIP_JBINDING_LIB 7-Zip-JBinding LOCATION)
GET_FILENAME_COMPONENT(SEVENZIP_JBINDING_LIB_FILENAME "${SEVENZIP_JBINDING_LIB}" NAME)

SET(SEVENZIP_JBINDING_LIB_PROPERTY_FILE sevenzipjbinding-lib.properties)
FILE(WRITE ${PROJECT_BINARY_DIR}/${SEVENZIP_JBINDING_LIB_PROPERTY_FILE} "sevenzipjbinding.libname.1=${SEVENZIP_JBINDING_LIB_FILENAME}\n")
IF(USE_MINGW)
    IF (MINWGM10_DLL_FILENAME MATCHES "/.*")
        IF(NOT CYGPATH_EXE_FILENAME)
            MESSAGE(FATAL_ERROR "cygpath.exe wasn't found")
        ENDIF(NOT CYGPATH_EXE_FILENAME)
        EXECUTE_PROCESS(COMMAND cygpath.exe -m ${MINWGM10_DLL_FILENAME} OUTPUT_VARIABLE MINWGM10_DLL_FILENAME) 
    ENDIF(MINWGM10_DLL_FILENAME MATCHES "/.*")
    GET_FILENAME_COMPONENT(MINWGM10_DLL_DIR ${MINWGM10_DLL_FILENAME} PATH)
    GET_FILENAME_COMPONENT(MINWGM10_DLL_NAME ${MINWGM10_DLL_FILENAME} NAME)
    FILE(APPEND ${PROJECT_BINARY_DIR}/${SEVENZIP_JBINDING_LIB_PROPERTY_FILE} "sevenzipjbinding.libname.2=${MINWGM10_DLL_NAME}")
ENDIF(USE_MINGW)

MESSAGE("----------------------------")
MESSAGE("Platform: ${PLATFORM}")
MESSAGE("LIB: ${SEVENZIP_JBINDING_LIB}")
MESSAGE("LIB-Name: ${SEVENZIP_JBINDING_LIB_FILENAME}")
MESSAGE("JAR: ${SEVENZIP_JBINDING_JAR}")
MESSAGE("SEVENZIPJBINDING_ZIP: ${SEVENZIPJBINDING_ZIP}")
MESSAGE("mingwm10.dll: ${MINWGM10_DLL_FILENAME}")
MESSAGE("-Tools:")
MESSAGE("JAR: ${JAVA_ARCHIVE}")
MESSAGE("----------------------------")

FILE(REMOVE ${SEVENZIPJBINDING_ZIP})

SET(CPACK_PACKAGE_DESCRIPTION_SUMMARY "SevenZip-JBinding - java binding for p7zip, crossplatform version of 7-Zip.")
SET(CPACK_PACKAGE_DESCRIPTION_SUMMARY ZIP)
SET(CPACK_GENERATOR ZIP)
SET(CPACK_SOURCE_GENERATOR ZIP)
#SET(CPACK_SOURCE_IGNORE_FILES /CVS/;/\\.svn/;\\.swp$;\\.#;/#;.*~;cscope.*)

INCLUDE(CPack)



ADD_CUSTOM_TARGET(SevenZipJBinding-lib-jar ALL
    DEPENDS ${SEVENZIPJBINDING_LIB_JAR}) 

ADD_DEPENDENCIES(SevenZipJBinding-lib-jar 7-Zip-JBinding) #sevenzip-jbinding-jar

IF(USE_MINGW)
    ADD_CUSTOM_COMMAND(TARGET SevenZipJBinding-lib-jar POST_BUILD
                       COMMAND ${JAVA_ARCHIVE} uf ${SEVENZIPJBINDING_LIB_JAR} 
                                               -C ${MINWGM10_DLL_DIR}
                                               ${MINWGM10_DLL_NAME}
                       WORKING_DIRECTORY ${PROJECT_BINARY_DIR}
                       COMMENT Adding mingwm10.dll to the jar)
ENDIF(USE_MINGW)

ADD_CUSTOM_COMMAND(OUTPUT ${SEVENZIPJBINDING_LIB_JAR}
                   COMMAND ${JAVA_ARCHIVE} cf ${SEVENZIPJBINDING_LIB_JAR} 
                                           -C ${PROJECT_BINARY_DIR}/jbinding-cpp
                                           ${SEVENZIP_JBINDING_LIB_FILENAME}
                   COMMAND ${JAVA_ARCHIVE} uf ${SEVENZIPJBINDING_LIB_JAR} 
                                           -C ${PROJECT_BINARY_DIR}
                                           ${SEVENZIP_JBINDING_LIB_PROPERTY_FILE}
                   DEPENDS ${SEVENZIP_JBINDING_LIB}
                   WORKING_DIRECTORY ${PROJECT_BINARY_DIR}
                   COMMENT Building Platformdependend jar)

INSTALL(FILES   AUTHORS
                ChangeLog
                COPYING
                LGPL
                NEWS
                README
                release-notes.txt
                THANKS
        DESTINATION .)
INSTALL(FILES   ${SEVENZIP_JBINDING_JAR} 
                ${SEVENZIPJBINDING_LIB_JAR}
        DESTINATION lib)

